name: Remote SSH Commanda
on:
  push:
    branches:
      - develop
  pull_request:
    types:
      - closed
    branches:
      - develop
  workflow_dispatch: {}

jobs:
  build:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Execute remote SSH commands using password
        uses: appleboy/ssh-action@v1
        with:
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          username: ${{ secrets.USERNAME }}
          host: ${{ secrets.EC2_HOST}}
          port: ${{ secrets.EC2_PORT }}
          script: |
            cd ~/work/github/shuttler-backend-dev
            git pull
            docker exec -it demo-backend-amd64 /pnpm/pm2 list
            docker exec -it demo-backend-amd64 /pnpm/pm2 stop api
            docker exec -it demo-backend-amd64 /pnpm/pm2 delete api
            echo "Delete ${{ secrets.DB_DATABASE_DEV }} database"
            psql -h ${{ DB_HOST }} -p ${{ secrets.DB_PORT }} -U ${{ secrets.DB_USERNAME }} -d postgres -c 'drop database if exists \"${{ secrets.DB_DATABASE_DEV }}\";'
            echo "Create ${{ secrets.DB_DATABASE_DEV }} database"
            psql -h ${{ DB_HOST }} -p ${{ secrets.DB_PORT }} -U ${{ secrets.DB_USERNAME }} -d postgres -c 'create database \"${{ secrets.DB_DATABASE_DEV }}\" with owner \"${{ secrets.DB_USERNAME }}\" template template0 encoding \"UTF8\";'
            docker exec -it demo-backend-amd64 npm run seed
            docker exec -it demo-backend-amd64 /pnpm/pm2 start ./bin/www.js --name api
            docker exec -it demo-backend-amd64 /pnpm/pm2 status


